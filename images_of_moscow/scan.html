<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <title>----</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #000;
    }

    #camerafeed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .prompt-box-8w {
      font-weight: 500;
      text-align: left !important;
      background-color: #00000030 !important;
      color: #fff !important;
      line-height: 22px !important;
      font-size: 17px !important;
      border-radius: 34px !important;
      padding: 14px !important;
      min-inline-size: 87%;
      letter-spacing: -0.43px;
      border: 1px solid transparent;
      background: linear-gradient(to right, #000000, #000000),
        linear-gradient(to right top, black 5%, gray 30%, black 100%);
      background-clip: padding-box, border-box;
      background-origin: padding-box, border-box;
    }

    .prompt-button-8w {
      background: #78788052;
      height: 48px;
      line-height: 22px;
      font-size: 17px;
      border-radius: 100px !important;
      font-weight: 400;
    }

    .button-primary-8w {
      background-color: #0091ff !important;
    }
  </style>

  <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.172.0/build/three.module.min.js",
          "three/addons/": "https://unpkg.com/three@0.172.0/examples/jsm/"
        }
      }
    </script>

  <!-- XR Extras - provides utilities like load screen, almost there, and error handling.
         See github.com/8thwall/web/tree/master/xrextras -->
  <script src="//8cdn.4app.pro/web/xrextras/xrextras.js"></script>
  <!-- 8thWall Web - Replace the app key here with your own app key -->
  <script async
    src="//8apps.4app.pro/xrweb?appKey=j2hNNtpTtKE7HghzgB8PUl2gykdNfU4OEZtpBApXZ4p7gwfvZpsveby44YlnZHF2NvlAN0"></script>

  <script type="module">
    import * as THREE from "three"
    window.THREE = { ...THREE }
    /*
      window.THREE.GLTFLoader = GLTFLoader;
      import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
      */
  </script>

  <script>
    let isRedirecting = false // Флаг, чтобы не редиректить много раз подряд

    // Событие 8th Wall: Срабатывает, когда изображение распознано
    const onXrImageFound = ({ detail }) => {
      if (isRedirecting) return

      const markerName = detail.name
      console.log(`Маркер найден: ${markerName}`)

      isRedirecting = true

      // Останавливаем движок, чтобы сэкономить ресурсы перед переходом
      XR8.pause()

      // Формируем ссылку и переходим
      const finalUrl = `${BASE_URL}&pid=${encodeURIComponent(markerName)}`
      window.location.href = finalUrl
    }

    // КОНФИГУРАЦИЯ
    const BASE_URL = "./?r=paint"

    // --- Модуль логики перенаправления ---
    // Это кастомный модуль пайплайна 8th Wall
    const redirectPipelineModule = () => {
      return {
        name: "redirect-logic",
        listeners: [{ event: "reality.imagefound", process: onXrImageFound }],
      }
    }

    // --- Основная функция инициализации ---
    const onXrLoaded = () => {
      // Инициализируем Three.js сцену, камеру и рендерер
      const scene = new THREE.Scene()
      const camera = new THREE.PerspectiveCamera(
        60,
        window.innerWidth / window.innerHeight,
        0.1,
        1000
      )

      const renderer = new THREE.WebGLRenderer({
        canvas: document.getElementById("camerafeed"),
        antialias: true,
        alpha: true,
      })
      renderer.setSize(window.innerWidth, window.innerHeight)
      renderer.setPixelRatio(window.devicePixelRatio)

      // Добавляем свет (не обязательно для сканирования, но нужно, если будете добавлять 3D объекты)
      scene.add(new THREE.AmbientLight(0x404040, 5))

      // Настройка 8th Wall
      XR8.addCameraPipelineModules([
        XR8.GlTextureRenderer.pipelineModule(),
        // Модуль интеграции с Three.js (рисует видео с камеры на задний план)
        XR8.Threejs.pipelineModule(),
        // Модуль контроллера (нужен для работы AR)
        XR8.XrController.pipelineModule(),
        // Наш кастомный модуль для редиректа
        redirectPipelineModule(),
        XRExtras ? XRExtras.AlmostThere.pipelineModule() : null,
        XRExtras ? XRExtras.FullWindowCanvas.pipelineModule() : null,
        XRExtras ? XRExtras.Loading.pipelineModule() : null,
        XRExtras ? XRExtras.RuntimeError.pipelineModule() : null,
      ])

      // Запуск движка
      XR8.run({
        canvas: document.getElementById("camerafeed"),
        scene: scene,
        camera: camera,
        renderer: renderer,
        allowedDevices: XR8.XrConfig.device().ANY, // Разрешить на всех устройствах

        // Конфигурация сканирования
        xrConfig: {
          disableWorldTracking: true, // Отключаем SLAM (поиск пола), оставляем только Image Target
        },
      })
    }

    // Ждем загрузки скрипта 8th Wall
    window.onload = () => {
      installRussianPreload()
      installRussianPreloadPrompt()
      if (window.XR8) {
        onXrLoaded()
      } else {
        window.addEventListener("xrloaded", onXrLoaded)
      }
    }

    let russianInstalled = false

    const installRussianPreload = () => {
      let installInterval = setInterval(() => {
        const requestingCameraPermissions = document.querySelector('#requestingCameraPermissions')
        const cameraPermissionsErrorAppleMessage = document.querySelector(
          '#cameraPermissionsErrorAppleMessage'
        )
        if (requestingCameraPermissions !== undefined) {
          requestingCameraPermissions.textContent = 'Нажмите "Разрешить" что бы камера заработала'
          cameraPermissionsErrorAppleMessage.textContent =
            'Перезагрузите страницу и разрешите доступ до камеры, что бы все заработало'
          clearInterval(installInterval)
        }
      }, 300)
    }

    let russianInstalledPrompt = false

    const installRussianPreloadPrompt = () => {
      let installInterval = setInterval(() => {
        if (document.querySelector('.prompt-box-8w')) {
          if (!russianInstalledPrompt) {
            document.querySelector('.prompt-box-8w p').innerHTML = 'Разрешите доступ до датчиков движения'
            document.querySelector('.prompt-button-8w').innerHTML = 'Отмена'
            document.querySelector('.button-primary-8w').innerHTML = 'Продолжить'
          }
          russianInstalledPrompt = true
          clearInterval(installInterval)
        }
      }, 300)
    }


    window._XR8Chunks = ['slam']
  </script>
</head>

<body>
  <!-- Канвас для отрисовки видео и 3D -->
  <canvas id="camerafeed"></canvas>
</body>

</html>